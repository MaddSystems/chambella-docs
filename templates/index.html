<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chambella Database Query</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

        body {
            background: linear-gradient(to right, #232526, #414345);
            color: #e0e0e0;
            font-family: 'Roboto', sans-serif;
            padding: 20px;
        }

        .container {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        h1, h3 {
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        .table {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }

        .table-striped>tbody>tr:nth-of-type(odd) {
            background-color: #343a40;
        }

        .table-hover>tbody>tr:hover {
            background-color: #495057;
            color: #ffffff;
        }

        .table th {
            background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
            color: #ffffff;
            border-bottom: 2px solid #495057;
        }

        .table td {
            vertical-align: middle;
        }

        .clickable-row {
            cursor: pointer;
        }

        .modal-content {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #495057;
        }

        .modal-header {
            background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
            color: #ffffff;
            border-bottom: 1px solid #495057;
        }

        .modal-title {
            color: #ffffff;
        }

        .btn-close {
            filter: invert(1);
        }

        .modal-body {
            background-color: #1e1e1e;
        }

        .modal-footer {
            border-top: 1px solid #495057;
        }

        .btn-primary {
            background: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background: #0056b3;
            border-color: #0056b3;
        }

        .btn-info {
            background: #17a2b8;
            border-color: #17a2b8;
        }

        .btn-danger {
            background: #dc3545;
            border-color: #dc3545;
        }

        .json-content {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
        }

        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: #e0e0e0 !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
            color: #6c757d !important;
        }

        .form-control {
            background-color: #343a40;
            color: #e0e0e0;
            border: 1px solid #495057;
        }

        .form-control:focus {
            background-color: #495057;
            color: #e0e0e0;
            border-color: #007bff;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">Chambella Session Flow</h1>

        <h3 class="mt-5">Users</h3>
        <table id="usersTable" class="table table-striped table-hover table-dark">
            <thead>
                <tr>
                    <th>Channel</th>
                    <th>Name</th>
                    <th>Phone Number</th>
                    <th>Last Access</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="clickable-row" data-bs-toggle="modal" data-bs-target="#sessionsModal{{ user.user_id }}">
                    <td>
                        {% if user.user_id.startswith('52') %}
                            <img src="/static/whatsapp-logo.ico" alt="WhatsApp" width="24" height="24">
                        {% else %}
                            <img src="/static/messenger-logo.ico" alt="Messenger" width="24" height="24">
                        {% endif %}
                    </td>
                    <td>{{ user.user_name }}</td>
                    <td>{{ user.contact_phone_number }}</td>
                    <td>{{ user.last_access }}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#sessionsModal{{ user.user_id }}">
                            <i class="fas fa-eye"></i> View Sessions
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% for user in users %}
    <div class="modal fade" id="sessionsModal{{ user.user_id }}" tabindex="-1" aria-labelledby="sessionsModalLabel{{ user.user_id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sessionsModalLabel{{ user.user_id }}">Sessions for User {{ user.user_id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-striped table-dark">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Referral ID</th> <th>Job ID</th>
                                <th>Job Title</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in user.sessions %}
                            <tr>
                                <td>{{ session.session_id }}</td>
                                <td>{{ session.current_ad_id | default('None', true) }}</td> <td>{{ session.current_job_id }}</td>
                                <td>{{ session.current_job_title }}</td>
                                <td>{{ session.create_time }}</td>
                                <td>{{ session.update_time }}</td>
                                <td>
                                    <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#detailsModal{{ session.session_id }}">
                                        <i class="fas fa-info-circle"></i> Details
                                    </button>
                                    <button class="btn btn-danger btn-sm ms-2" onclick="deleteSession('{{ user.user_id }}', '{{ session.session_id }}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    {% for session in user.sessions %}
    <div class="modal fade" id="detailsModal{{ session.session_id }}" tabindex="-1" aria-labelledby="detailsModalLabel{{ session.session_id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel{{ session.session_id }}">Details for Session {{ session.session_id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">


                    <h6>Events</h6>
                    <table class="table table-bordered nested-table table-dark">
                        <thead>
                            <tr>
                                <th style="width: 140px;">Timestamp</th>
                                <th style="width: 120px;">Author</th>
                                <th style="text-align: left; width: 100%;">Content</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in session.events %}
                            <tr>
                                <td style="width: 140px; white-space: nowrap;">
                                    {% set ts = event.timestamp.replace(' CST', '') %}
                                    {% set parts = ts.split(' ')[0].split('-') %}
                                    {% set year = parts[0][2:] %}
                                    {% set month = parts[1] %}
                                    {% set day = parts[2] %}
                                    {{ day }}-{{ month }}-{{ year }} {{ ts.split(' ')[1] if ts.split(' ')|length > 1 else '' }}
                                </td>
                                <td style="width: 120px;">{{ event.author }}</td>
                                <td class="json-content event-content" 
                                    data-json='{{ event.content | tojson | safe }}' 
                                    style="text-align: left; width: 100%; padding-right: 0.5rem; padding-left: 0.5rem; word-break: break-word;">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% endfor %}

    <div class="modal fade" id="deleteSessionModal" tabindex="-1" aria-labelledby="deleteSessionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteSessionModalLabel">Delete Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Warning!</strong> This action will permanently delete the session and create a new empty one.
                    </div>
                    <p>Are you sure you want to delete this session?</p>
                    <p><strong>User ID:</strong> <span id="deleteUserId"></span></p>
                    <p><strong>Session ID:</strong> <span id="deleteSessionId"></span></p>
                    
                    <div class="mb-3">
                        <label for="deletePassword" class="form-label">Enter password to confirm:</label>
                        <input type="password" class="form-control" id="deletePassword" placeholder="Password required">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteSession()">
                        <i class="fas fa-trash"></i> Delete Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize DataTables with search and sorting
            $('#usersTable').DataTable({
                "paging": true,
                "searching": true,
                "ordering": true,
                "order": [[3, "desc"]], // Default sort by Last Access (descending)
                "pageLength": 10,
                "language": {
                    "search": "Search Users:",
                    "searchPlaceholder": "Search by ID, name, or phone..."
                }
            });

            // Ensure modals stack correctly
            $(document).on('hidden.bs.modal', '.modal', function () {
                if ($('.modal:visible').length) {
                    $('body').addClass('modal-open');
                }
            });

            // ---- JAVASCRIPT FIX: Changed selector to target the <td> directly ----
            $('td.event-content').each(function() {
                let jsonStr = $(this).attr('data-json');
                let content = null;
                try {
                    content = JSON.parse(jsonStr);
                } catch (e) {
                    $(this).text('Invalid JSON');
                    return;
                }
                // Check for 'parts' array with 'text' key
                if (content.parts && Array.isArray(content.parts)) {
                    let textFound = false;
                    content.parts.forEach(function(part) {
                        if (part.text) {
                            $(this).text(part.text.trim());
                            textFound = true;
                        }
                    }.bind(this));
                    if (!textFound) {
                        // No text found, show Process button
                        addProcessButton(this, content);
                    }
                } else {
                    // No 'parts', show Process button
                    addProcessButton(this, content);
                }
            });

            function addProcessButton(element, jsonObj) {
                let btn = $('<button class="btn btn-sm btn-primary">Process</button>');
                btn.on('click', function() {
                    showJsonModal(jsonObj);
                });
                $(element).empty().append(btn);
            }

            function showJsonModal(jsonObj) {
                let modalHtml = '<div class="modal fade" id="jsonModal" tabindex="-1" aria-labelledby="jsonModalLabel" aria-hidden="true">';
                modalHtml += '<div class="modal-dialog modal-lg"><div class="modal-content">';
                modalHtml += '<div class="modal-header"><h5 class="modal-title" id="jsonModalLabel">JSON Content</h5>';
                modalHtml += '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>';
                modalHtml += '<div class="modal-body"><pre>' + JSON.stringify(jsonObj, null, 2) + '</pre></div>';
                modalHtml += '<div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>';
                modalHtml += '</div></div></div>';
                // Remove any existing modal
                $('#jsonModal').remove();
                $('body').append(modalHtml);
                var modal = new bootstrap.Modal(document.getElementById('jsonModal'));
                modal.show();
            }
        });

        // Session deletion functions
        let currentUserId = null;
        let currentSessionId = null;

        function deleteSession(userId, sessionId) {
            currentUserId = userId;
            currentSessionId = sessionId;
            // Set the values in the modal
            document.getElementById('deleteUserId').textContent = userId;
            document.getElementById('deleteSessionId').textContent = sessionId;
            // Clear password field
            document.getElementById('deletePassword').value = '';
            // Show the modal
            new bootstrap.Modal(document.getElementById('deleteSessionModal')).show();
        }

        function confirmDeleteSession() {
            const password = document.getElementById('deletePassword').value;
            if (password !== '{{ delete_password }}') {
                alert('Incorrect password. Access denied.');
                return;
            }
            if (!currentUserId || !currentSessionId) {
                alert('Error: Missing session information.');
                return;
            }
            console.log('Starting delete request for:', currentUserId, currentSessionId);
            // Show loading state
            const deleteBtn = document.querySelector('#deleteSessionModal .btn-danger');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            deleteBtn.disabled = true;
            // Make the deletion request
            fetch('/api/delete-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: currentUserId,
                    session_id: currentSessionId,
                    password: password
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    alert('Session deleted successfully and new empty session created!');
                    // Reload the page to show updated data
                    location.reload();
                } else {
                    alert('Error deleting session: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Error deleting session: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('deleteSessionModal')).hide();
            });
        }
    </script>
</body>
</html>